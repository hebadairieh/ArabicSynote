/*!
 * Synote Media Fragment Player
 *
 * Playing Media Fragment URIs using mediaelementjs player
 *  
 * Copyright 2013 Yunjia Li, University of Southampton (http://www.ecs.soton.ac.uk/people/yl2)
 * Licensed under the MIT License.
 *
 */var MediaFragments=function(b){if(!Array.prototype.forEach)Array.prototype.forEach=function(l,k){if(this===void 0||this===null)throw new TypeError;var c=Object(this),j=c.length>>>0;if(typeof l!=="function")throw new TypeError;for(var i=0;i<j;i++)i in c&&l.call(k,c[i],i,c)};var e=function(l){console.log("Media Fragments URI Parsing Warning: "+l)},r={t:function(l){var k=l.split(",");if(k.length>2)return false;var c=k[0]?k[0]:"";k=k[1]?k[1]:"";if(c===""&&k===""||c&&!k&&l.indexOf(",")!==-1)return false;
var j=/^((npt\:)?((\d+\:(\d\d)\:(\d\d))|((\d\d)\:(\d\d))|(\d+))(\.\d*)?)?$/;if(j.test(c)&&j.test(k)){c=c.replace(/^npt\:/,"");c=c.replace(/\.$/,"");k=k.replace(/\.$/,"");j=function(a){if(a==="")return false;var f,d;a=a.split(":");f=a.length;if(f===3){f=parseInt(a[0],10);d=parseInt(a[1],10);a=parseFloat(a[2])}else if(f===2){f=0;d=parseInt(a[0],10);a=parseFloat(a[1])}else if(f===1){d=f=0;a=parseFloat(a[0])}else return false;if(f>23){e("Please ensure that hours <= 23.");return false}if(d>59){e("Please ensure that minutes <= 59.");
return false}if(a>=60){e("Please ensure that seconds < 60.");return false}return f*3600+d*60+a};var i=j(c),n=j(k);if(c&&k)if(i<n)return{value:l,unit:"npt",start:c,end:k,startNormalized:i,endNormalized:n};else{e("Please ensure that start < end.");return false}else if(j(c)!==false||j(k)!==false)return{value:l,unit:"npt",start:c,end:k,startNormalized:i===false?"":i,endNormalized:n===false?"":n};else{e("Please ensure that start or end are legal.");return false}}j=/^(\d+\:\d\d\:\d\d(\:\d\d(\.\d\d)?)?)?$/;
i=c.replace(/^(smpte(-25|-30|-30-drop)?).*/,"$1");c=c.replace(/^smpte(-25|-30|-30-drop)?\:/,"");if(j.test(c)&&j.test(k)){j=function(a){if(a==="")return false;var f,d,g,m;a=a.split(":");f=a.length;if(f===3){f=parseInt(a[0],10);d=parseInt(a[1],10);g=parseInt(a[2],10);m=a=0}else if(f===4){f=parseInt(a[0],10);d=parseInt(a[1],10);g=parseInt(a[2],10);if(a[3].indexOf(".")===-1){a=parseInt(a[3],10);m=0}else{m=a[3].split(".");a=parseInt(m[0],10);m=parseInt(m[1],10)}}else return false;if(f>23){e("Please ensure that hours <= 23.");
return false}if(d>59){e("Please ensure that minutes <= 59.");return false}if(g>59){e("Please ensure that seconds <= 59.");return false}return f*3600+d*60+g+a*0.0010+m*1.0E-6};if(c&&k)if(j(c)<j(k))return{value:l,unit:i,start:c,end:k};else{e("Please ensure that start < end.");return false}else if(j(c)!==false||j(k)!==false)return{value:l,unit:i,start:c,end:k};else{e("Please ensure that start or end are legal.");return false}}j=/^((\d{4})(-(\d{2})(-(\d{2})(T(\d{2})\:(\d{2})(\:(\d{2})(\.(\d+))?)?(Z|(([-\+])(\d{2})\:(\d{2})))?)?)?)?)?$/;
c=c.replace("clock:","");if(j.test(c)&&j.test(k))if(c&&k&&!isNaN(Date.parse("2009-07-26T11:19:01Z")))if(Date.parse(c)<=Date.parse(k))return{value:l,unit:"clock",start:c,end:k};else{e("Please ensure that start < end.");return false}else return{value:l,unit:"clock",start:c,end:k};e("Invalid time dimension.");return false},xywh:function(l){var k=/^percent\:\d+,\d+,\d+,\d+$/,c=l.replace(/(pixel|percent)\:/,"").split(","),j=c[0],i=c[1],n=c[2];c=c[3];if(/^(pixel\:)?\d+,\d+,\d+,\d+$/.test(l))if(n>0&&c>0)return{value:l,
unit:"pixel",x:j,y:i,w:n,h:c};else{e("Please ensure that w > 0 and h > 0");return false}else{if(k.test(l)){if(function(a,f,d,g){if(!(0<=a&&a<=100)){e("Please ensure that 0 <= x <= 100.");return false}if(!(0<=f&&f<=100)){e("Please ensure that 0 <= y <= 100.");return false}if(!(0<=d&&d<=100)){e("Please ensure that 0 <= w <= 100.");return false}if(!(0<=g&&g<=100)){e("Please ensure that 0 <= h <= 100.");return false}return true}(j,i,n,c))return{value:l,unit:"percent",x:j,y:i,w:n,h:c};e("Invalid percent selection.")}else e("Invalid spatial dimension.");
return false}},track:function(l){return{value:l,name:l}},id:function(l){return{value:l,name:l}},chapter:function(l){return{value:l,chapter:l}}},q=function(l){var k={};l.split("&").forEach(function(c){var j=c.indexOf("=");if(!(j<1)){var i=[c.substring(0,j),c.substring(j+1)];if(i[1]){c=decodeURIComponent(i[0]);j=r[c];i=decodeURIComponent(i[1]);if(j)if(i=j(i)){k[c]||(k[c]=[]);if(c!=="t")k[c].push(i);else k[c][0]=i}}}});return k};return{parse:function(l){return MediaFragments.parseMediaFragmentsUri(l)},
parseMediaFragmentsUri:function(l){l=l?l:b.location.href;var k=l.indexOf("#"),c=l.indexOf("?"),j=k!==-1?k:l.length;c=c!==-1?l.substring(c+1,j):"";l=k!==-1?l.substring(k+1):"";var i=q(c),n=q(l);return{query:i,hash:n,toString:function(){var a=function(f,d){var g="\n["+f+"]:\n";if(!Object.keys)Object.keys=function(m){if(m!==Object(m))throw new TypeError("Object.keys called on non-object");var o=[],p;for(p in m)Object.prototype.hasOwnProperty.call(m,p)&&o.push(p);return o};Object.keys(d).forEach(function(m){g+=
"  * "+m+":\n";d[m].forEach(function(o){g+="    [\n";Object.keys(o).forEach(function(p){g+="      - "+p+": "+o[p]+"\n"});g+="   ]\n"})});return g};return a("Query",i)+a("Hash",n)}}}}}(window),smfplayer=smfplayer||{};smfplayer.version="v0.2";
smfplayer.utils={durationMax:4294967295,audioList:["wma","m4a","mp3","wav","mpeg"],videoList:["mp4","m4v","mov","wmv","flv","ogg","webm"],isYouTubeURL:function(b,e){return b.match(/^https?:\/\/(?:www\.)?youtube\.com\/watch\?(?=.*v=((\w|-){11}))(?:\S+)?$/)?e!==true?RegExp.$1:true:false},isDailyMotionURL:function(b){return b.match(/^.+dailymotion.com\/(video|hub)\/([^_]+)[^#]*(#video=([^_&]+))?/)!==null?true:false},isVimeoURL:function(b){return b.match(/^.+vimeo.com\/(\d+)?/)!==null?true:false},isValidURL:function(b){return/^(([\w]+:)?\/\/)?(([\d\w]|%[a-fA-f\d]{2,2})+(:([\d\w]|%[a-fA-f\d]{2,2})+)?@)?([\d\w][-\d\w]{0,253}[\d\w]\.)+[\w]{2,4}(:[\d]+)?(\/([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)*(\?(&?([-+_~.\d\w]|%[a-fA-f\d]{2,2})=?)*)?(#([-+_~.\d\w]|%[a-fA-f\d]{2,2})*)?$/.test(b)?
true:false},isiPad:function(){return navigator.userAgent.match(/iPad/i)==null?false:true},getTemporalMF:function(b){var e=b.start?b.startNormalized:0;b=b.end?b.endNormalized:durationMax;e=parseFloat(e);b=parseFloat(b);return{st:e,et:b}},getSpatialMF:function(){}};
(function(b,e){function r(a,f){var d=decodeURI(a);d=j[f?"strict":"loose"].exec(d);for(var g={attr:{},param:{},seg:{}},m=14;m--;)g.attr[k[m]]=d[m]||"";g.param.query={};g.param.fragment={};g.attr.query.replace(i,function(o,p,s){if(p)g.param.query[p]=s});g.attr.fragment.replace(n,function(o,p,s){if(p)g.param.fragment[p]=s});g.seg.path=g.attr.path.replace(/^\/+|\/+$/g,"").split("/");g.seg.fragment=g.attr.fragment.replace(/^\/+|\/+$/g,"").split("/");g.attr.base=g.attr.host?g.attr.protocol+"://"+g.attr.host+
(g.attr.port?":"+g.attr.port:""):"";return g}function q(a){a=a.tagName;if(a!==e)return l[a.toLowerCase()];return a}var l={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href"},k=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","fragment"],c={anchor:"fragment"},j={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},i=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,n=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g;b.fn.url=function(a){var f="";if(this.length)f=b(this).attr(q(this[0]))||"";return b.url(f,a)};b.url=function(a,f){if(arguments.length===1&&a===true){f=true;a=e}f=f||false;a=a||window.location.toString();return{data:r(a,f),attr:function(d){d=
c[d]||d;return d!==e?this.data.attr[d]:this.data.attr},param:function(d){return d!==e?this.data.param.query[d]:this.data.param.query},fparam:function(d){return d!==e?this.data.param.fragment[d]:this.data.param.fragment},segment:function(d){if(d===e)return this.data.seg.path;else{d=d<0?this.data.seg.path.length+d:d-1;return this.data.seg.path[d]}},fsegment:function(d){if(d===e)return this.data.seg.fragment;else{d=d<0?this.data.seg.fragment.length+d:d-1;return this.data.seg.fragment[d]}}}}})(jQuery);
(function(b){var e,r=true,q=false,l={width:640,height:480,originalWidth:320,originalHeight:240,isVideo:true,mfAlwaysEnabled:false,spatialEnabled:true,spatialStyle:{},autoStart:true},k={init:function(j){e=this;var i=b.extend({},l,j);if(i.mfURI===undefined){console.error("mfURI cannot be null!");return false}this.pause=function(){b(this).data("smfplayer").smfplayer!==undefined?b(this).data("smfplayer").smfplayer.pause():console.error("smfplayer hasn't been initalised")};this.play=function(){var a=b(this).data("smfplayer").smfplayer;
a!==undefined?a.play():console.error("smfplayer hasn't been initalised")};this.playmf=function(){var a=b(this).data("smfplayer");if(a===undefined)setTimeout(function(){e.playmf()},100);else{var f=0;if(!b.isEmptyObject(a.mfjson.hash))f=smfplayer.utils.getTemporalMF(a.mfjson.hash.t[0]).st;a=b(this).data("smfplayer").smfplayer;this.setPosition(f*1E3);a.media.paused&&a.play();this.mfreplay=true}};this.showxywh=function(a){var f=b(this).data("smfplayer");if(f===undefined)setTimeout(function(){e.showxywh(a)},
100);else if(!(b.isEmptyObject(a)||f.settings.spatialEnabled!==true)){var d;if(f.settings.xywhoverlay===undefined){this.addClass("smfplayer-container");d=b("<div/>");d.css(f.settings.spatialStyle);d.addClass("smfplayer-overlay").appendTo(this);f.settings.xywhoverlay=d}else d=f.settings.xywhoverlay;var g=a.unit;x=a.x;y=a.y;w=a.w;h=a.h;if(g==="percent"){x=Math.floor(x/100*f.settings.width);w=Math.floor(w/100*f.settings.width);y=Math.floor(y/100*f.settings.height);h=Math.floor(h/100*f.settings.height)}d.css({width:w,
height:h,top:y+"px",left:x+"px"});d.show()}};this.hidexywh=function(){var a=b(this).data("smfplayer");if(a===undefined)setTimeout(function(){e.hidexywh()},100);else a.settings.xywhoverlay!==undefined&&a.settings.xywhoverlay.hide()};this.stop=function(){var a=b(this).data("smfplayer").smfplayer;a!==undefined?a.stop():console.error("smfplayer hasn't been initalised")};this.load=function(){var a=b(this).data("smfplayer").smfplayer;a!==undefined?a.load():console.error("smfplayer hasn't been initalised")};
this.getPosition=function(){var a=b(this).data("smfplayer").smfplayer;if(a)return parseInt(a.getCurrentTime()*1E3);else{console.error("smfplayer hasn't been initalised");return-1}};this.setPosition=function(a){var f=b(this).data("smfplayer").smfplayer;a=a?a:0;if(f!==undefined)e.getPosition()<=0?setTimeout(function(){e.setPosition(a)},100):f.setCurrentTime(a/1E3);else console.error("smfplayer hasn't been initalised")};this.getDuration=function(){var a=b(this).data("smfplayer").smfplayer;if(a!==undefined)return a.duration*
1E3;else{console.error("smfplayer hasn't been initalised");return-1}};this.getMFJson=function(){return b(this).data("smfplayer").mfjson};this.getMeplayer=function(){return b(this).data("smfplayer").smfplayer};var n=MediaFragments.parseMediaFragmentsUri(i.mfURI);i.success=function(a,f){if(i.autoStart===true)if(a.pluginType=="flash")a.addEventListener("canplay",function(){a.play();if(b(e).data("smfplayer")===undefined)setTimeout(function(){var m=c(b(e).data("smfplayer").mfjson);e.setPosition(m.st*1E3);
!b.isEmptyObject(m.xywh)&&b(e).data("smfplayer").settings.spatialEnabled===true&&e.showxywh(m.xywh)},100);else{var g=c(b(e).data("smfplayer").mfjson);e.setPosition(g.st*1E3);!b.isEmptyObject(g.xywh)&&b(e).data("smfplayer").settings.spatialEnabled===true&&e.showxywh(g.xywh)}},false);else{a.play();if(b(e).data("smfplayer")===undefined)setTimeout(function(){var g=c(b(e).data("smfplayer").mfjson);e.setPosition(g.st*1E3);!b.isEmptyObject(g.xywh)&&b(e).data("smfplayer").settings.spatialEnabled===true&&
e.showxywh(g.xywh)},100);else{var d=c(b(e).data("smfplayer").mfjson);e.setPosition(d.st*1E3);!b.isEmptyObject(d.xywh)&&b(e).data("smfplayer").settings.spatialEnabled===true&&e.showxywh(d.xywh)}}a.addEventListener("timeupdate",function(){var g=a.currentTime,m=b(e).data("smfplayer");if(m!==undefined){var o=c(m.mfjson),p=o.st,s=o.et;o=o.xywh;if(g<s&&g>p){if(m!==undefined)if(!b.isEmptyObject(o)&&m.settings.spatialEnabled===true)if(m.settings.xywhoverlay===undefined||!m.settings.xywhoverlay.is(":visible"))e.showxywh(o);
if(q===true)q=false}else{m.settings.xywhoverlay!==undefined&&m.settings.xywhoverlay.is(":visible")&&e.hidexywh();if(r===true||i.mfAlwaysEnabled===true)if(g>s){a.pause();e.setPosition(s*1E3);r=false}else if(g<p)if(q===false){e.setPosition(p*1E3);q=true}}}},false);a.addEventListener("play",function(){var g=a.currentTime,m=b(e).data("smfplayer");if(m!==undefined){var o=c(m.mfjson);m=o.st;o=o.et;if(r===true)if(g<m){if(q===false){e.setPosition(m*1E3);q=true}}else if(g>o)if(q===false){e.setPosition(o*1E3);
q=true;a.pause();r=false}}},false);if(j.success!==undefined)return j.success.call(this,a,f)};i.error=function(){if(j.error!==undefined)return j.error.call(this)};return this.each(function(){var a=b(this);if(a.data("smfplayer")===undefined){var f=i.mfURI;if(!b.isEmptyObject(n.hash)){var d=i.mfURI.indexOf("#");f=d!==-1?i.mfURI.substring(0,d):i.mfURI}d=i.isVideo===false?b("<audio/>").prop("width",i.width).prop("height",i.height).prop("preload","auto").appendTo(a):b("<video/>").prop("width",i.width).prop("height",
i.height).prop("preload","auto").appendTo(a);f=b("<source/>").prop("src",f).appendTo(d);if(smfplayer.utils.isYouTubeURL(i.mfURI))f.prop("type","video/x-youtube");else if(smfplayer.utils.isDailyMotionURL(i.mfURI))f.prop("type","video/dailymotion");else if(smfplayer.utils.isVimeoURL(i.mfURI))f.prop("type","video/vimeo");else{var g=b.url(i.mfURI).attr("file").toLowerCase().split(".");if(g.length>1)if(g=g[g.length-1].toLowerCase())if(b.inArray(g,smfplayer.utils.videoList)!=-1)f.attr("type","video/"+g);
else b.inArray(g,smfplayer.utils.audioList)!=-1&&f.prop("type","audio/"+g)}i.subtitles!==undefined&&a.initSubtitles(d,i.subtitles);d=new MediaElementPlayer(d.get(0),i);a.data("smfplayer",{target:a,smfplayer:d,settings:i,mfjson:n})}})},destroy:function(){return this.each(function(){var j=b(this);j.data("smfplayer");b(window).unbind(".smfplayer");j.removeData("smfplayer");j.empty()})}},c=function(j){var i=0,n=smfplayer.utils.durationMax;if(!b.isEmptyObject(j.hash.t)){n=smfplayer.utils.getTemporalMF(j.hash.t[0]);
i=n.st;n=n.et}var a={};b.isEmptyObject(j.hash.xywh)||(a=j.hash.xywh[0]);return{st:i,et:n,xywh:a}};b.fn.smfplayer=function(j){if(k[j])return k[j].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof j==="object"||!j)return k.init.apply(this,arguments);else b.error("Method "+j+" does not exist on jQuery.smfplayer")}})(jQuery);
